<!doctype html>

<html>
  <head>
    {% from 'macros.html' import checkbox, slider, card_header, collapse_handler %} 
    <meta charset="utf-8">

    <link rel="icon" type="image/x-icon" href="/static/favicon.ico"> 
    <link rel="stylesheet" href="/static/bootstrap.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script type='text/javascript' src='https://webrtc.github.io/adapter/adapter-latest.js'></script>
    <script type='text/javascript' src='/static/webrtc.js'></script>
    <script type='text/javascript' src='/static/rest.js'></script>
    <script type='text/javascript' src='/static/debounce.js'></script>
    <script type='text/javascript' src="/static/jquery-3.6.3.min.js"></script>
    <script type='text/javascript' src='/static/bootstrap.bundle.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js"></script>

    <script type='text/javascript'>
      function toggleFullScreenContainer() {
        var container = document.querySelector('.video-container'); // 비디오 컨테이너 선택
        if (!document.fullscreenElement) {
          if (container.requestFullscreen) {
            container.requestFullscreen();
          } else if (container.mozRequestFullScreen) { // Firefox
            container.mozRequestFullScreen();
          } else if (container.webkitRequestFullscreen) { // Chrome, Safari & Opera
            container.webkitRequestFullscreen();
          } else if (container.msRequestFullscreen) { // IE/Edge
            container.msRequestFullscreen();
          }
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.mozCancelFullScreen) { // Firefox
            document.mozCancelFullScreen();
          } else if (document.webkitExitFullscreen) { // Chrome, Safari and Opera
            document.webkitExitFullscreen();
          } else if (document.msExitFullscreen) { // IE/Edge
            document.msExitFullscreen();
          }
        }
      }
      
      play = function() {
        var videoStreams = [
          getWebsocketURL(name = 'output', port = 8554),
          getWebsocketURL(name = 'output', port = 8555),
          getWebsocketURL(name = 'output', port = 8556),
          getWebsocketURL(name = 'output', port = 8557)
        ];
        var videoPlayers = [
          document.getElementById('gum1'),
          document.getElementById('gum2'),
          document.getElementById('gum3'),
          document.getElementById('gum4')
        ];
      
        videoPlayers.forEach(function(videoPlayer, index) {
          var videoStream = videoStreams[index];
          setupVideoPlayer(videoPlayer, videoStream);
        });
      };
      // 기존의 play와 stop 함수를 하나로 통합
      function toggleVideoPlayers() {
        var videoPlayers = document.querySelectorAll('.video-player');
        videoPlayers.forEach(function(videoPlayer) {
          if (videoPlayer.paused || videoPlayer.ended) {
            videoPlayer.play();
          } else {
            videoPlayer.pause();
            videoPlayer.currentTime = 0; 
          }
        });
        updatePlayPauseButton();
      }

      // 재생/정지 버튼 아이콘 업데이트
      function updatePlayPauseButton() {
        var videoPlayers = document.querySelectorAll('.video-player');
        var anyPlaying = Array.from(videoPlayers).some(video => !video.paused && !video.ended);
        var icon = document.querySelector('#toggleVideo i');
        icon.className = anyPlaying ? 'fa fa-pause' : 'fa fa-play';
      }
      var isRecording = false; // 녹화 상태를 추적하는 변수
      function toggleRecording() {
        // 녹화 상태에 따라 녹화 시작 또는 중단
        if (isRecording) {
            stopRecording();
            document.getElementById('toggleRecording').innerHTML = '<i class="fa fa-circle"></i>';
        } else {
            startRecording();
            document.getElementById('toggleRecording').innerHTML = '<i class="fa fa-stop"></i>';
        }
        isRecording = !isRecording; // 녹화 상태 토글
    }
      window.onload = function() {
        
        document.getElementById('toggleRecording').addEventListener('click', toggleRecording);
        document.getElementById('download').addEventListener('click', download); 
        document.getElementById('toggleVideo').addEventListener('click', toggleVideoPlayers);
        var videoContainer = document.querySelector('.video-container');
        videoContainer.addEventListener('mouseenter', showControls);
        videoContainer.addEventListener('mouseleave', hideControls);
        play(); // 시작 시 모든 비디오 재생
        var icon = document.querySelector('#toggleVideo i');
        icon.className = 'fa fa-pause';
      };

      function showControls() {
        document.getElementById('videoControls').style.display = 'block';
      }

      function hideControls() {
        document.getElementById('videoControls').style.display = 'none';
      }
      
    </script>
    
    <style>
      /* 비디오 컨테이너 스타일 */

      .video-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* 2열 그리드 */
        position: relative; 
      }
      /* 비디오 플레이어 스타일 */
      .video-player {
        width: 100%; /* 부모 컨테이너에 맞게 조절 */
      }
      @media screen and (max-width:1799px) {
        .video-container {
          display: grid;
          grid-template-columns: repeat(2, 1fr); /* 2열 그리드 */
          position: relative; 
        }
        /* 비디오 플레이어 스타일 */
        .video-player {
          width: 100%; /* 부모 컨테이너에 맞게 조절 */
          aspect-ratio: 16 / 9; /* 비디오 비율 유지 */
        }
      }
        .video-controls {
          position: absolute;
          bottom: 10px;
          left: 10px;
          display: none; /* 기본적으로 숨김 */
        }
        .btn {
          background-color: transparent !important; /* Set button background color to transparent */
          border: none !important; /* Remove button outline */
          box-shadow: none !important; /* Remove button shadow */
        }
        #toggleFullScreen {
          margin-left: auto; /* Move the button to the right end */
        }
    </style>
  </head>

  <body>

    <nav class="navbar navbar-expand-lg bg-dark text-white" style="padding: 0;">
      <div class="container-fluid">
        <a href="https://github.com/dgdgksj/NRU-110v-WebRTC-VideoStream" class="navbar-brand" style="font-size: 20px;">{{ title }}</a>
        <div class="d-flex align-items-center ms-auto">
          <span class="me-1" style="font-size: 14px;">powered by</span>
          <a href="http://www.givet.re.kr/" class="me-1 navbar-brand" style="font-size: 20px;">GIVET</a>
          <span class="me-1" style="font-size: 14px;">and</span>
          <a href="https://github.com/dusty-nv/jetson-inference" class="me-1 navbar-brand" style="font-size: 20px;">NVIDIA(dusty-nv)</a>
        </div>
      </div>
    </nav>
    
    
    
    
      
    <div class="video-container">
      <video id="gum1" class="video-player" playsinline autoplay muted></video>
      <video id="gum2" class="video-player" playsinline autoplay muted></video>
      <video id="gum3" class="video-player" playsinline autoplay muted></video>
      <video id="gum4" class="video-player" playsinline autoplay muted></video>
      <div class="video-container">
        <!-- Video elements omitted for brevity -->
        <div class="video-controls" id="videoControls" style="display: none;">
          <button id="toggleVideo" class="btn btn-primary">
            <i class="fa fa-play"></i> 
          </button>
          <button id="toggleRecording" class="btn btn-primary">
            <i class="fa fa-circle"></i>
          </button>          
          <button id="download" class="btn btn-success">
            <i class="fa fa-download"></i>
          </button>
          <!-- 원본녹화
          <input class="form-check-input" type="checkbox" id="recording_enabled" onchange="toggleRecording(this);">
                          <label class="form-check-label" for="recording_enabled">Enable Raw Recording</label>
          -->
          <!-- 전체화면 버튼 -->
          <button onclick="toggleFullScreenContainer()" class="btn btn-light">
            <i class="fa fa-arrows-alt"></i>
          </button>
        </div>
      </div>
    </div>
  </body>
</html>