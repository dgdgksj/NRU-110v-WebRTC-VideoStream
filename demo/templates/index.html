<!doctype html>

<html>
  <head>
    {% from 'macros.html' import checkbox, slider, card_header, collapse_handler %} 
    <meta charset="utf-8">

    <link rel="icon" type="image/x-icon" href="/static/favicon.ico"> 
    <link rel="stylesheet" href="/static/bootstrap.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script type='text/javascript' src='https://webrtc.github.io/adapter/adapter-latest.js'></script>
    <script type='text/javascript' src='/static/webrtc.js'></script>
    <script type='text/javascript' src='/static/rest.js'></script>
    <script type='text/javascript' src='/static/debounce.js'></script>
    <script type='text/javascript' src="/static/jquery-3.6.3.min.js"></script>
    <script type='text/javascript' src='/static/bootstrap.bundle.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js"></script>

    <script type='text/javascript'>
      function toggleFullScreenContainer() {
        var container = document.querySelector('.video-container'); // 비디오 컨테이너 선택
        if (!document.fullscreenElement) {
          if (container.requestFullscreen) {
            container.requestFullscreen();
          } else if (container.mozRequestFullScreen) { // Firefox
            container.mozRequestFullScreen();
          } else if (container.webkitRequestFullscreen) { // Chrome, Safari & Opera
            container.webkitRequestFullscreen();
          } else if (container.msRequestFullscreen) { // IE/Edge
            container.msRequestFullscreen();
          }
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          } else if (document.mozCancelFullScreen) { // Firefox
            document.mozCancelFullScreen();
          } else if (document.webkitExitFullscreen) { // Chrome, Safari and Opera
            document.webkitExitFullscreen();
          } else if (document.msExitFullscreen) { // IE/Edge
            document.msExitFullscreen();
          }
        }
      }
      
      play = function() {
        var videoStreams = [
          getWebsocketURL(name = 'output', port = 8554),
          getWebsocketURL(name = 'output', port = 8555),
          getWebsocketURL(name = 'output', port = 8556),
          getWebsocketURL(name = 'output', port = 8557)
        ];
        var videoPlayers = [
          document.getElementById('gum1'),
          document.getElementById('gum2'),
          document.getElementById('gum3'),
          document.getElementById('gum4')
        ];
      
        videoPlayers.forEach(function(videoPlayer, index) {
          var videoStream = videoStreams[index];
          setupVideoPlayer(videoPlayer, videoStream);
        });
      };
      // 기존의 play와 stop 함수를 하나로 통합
      function toggleVideoPlayers() {
        var videoPlayers = document.querySelectorAll('.video-player');
        videoPlayers.forEach(function(videoPlayer) {
          if (videoPlayer.paused || videoPlayer.ended) {
            videoPlayer.play();
          } else {
            videoPlayer.pause();
            videoPlayer.currentTime = 0; 
          }
        });
        updatePlayPauseButton();
      }

      // 재생/정지 버튼 아이콘 업데이트
      function updatePlayPauseButton() {
        var videoPlayers = document.querySelectorAll('.video-player');
        var anyPlaying = Array.from(videoPlayers).some(video => !video.paused && !video.ended);
        var icon = document.querySelector('#toggleVideo i');
        icon.className = anyPlaying ? 'fa fa-pause' : 'fa fa-play';
      }

      window.onload = function() {
        document.getElementById('startRecording').addEventListener('click', startRecording);
        document.getElementById('stopRecording').addEventListener('click', stopRecording);
        document.getElementById('download').addEventListener('click', download); 
        document.getElementById('toggleVideo').addEventListener('click', toggleVideoPlayers);
        var videoContainer = document.querySelector('.video-container');
        videoContainer.addEventListener('mouseenter', showControls);
        videoContainer.addEventListener('mouseleave', hideControls);
        play(); // 시작 시 모든 비디오 재생
      };

      function showControls() {
        document.getElementById('videoControls').style.display = 'block';
      }

      function hideControls() {
        document.getElementById('videoControls').style.display = 'none';
      }
      
    </script>
    
    <style>
      /* 비디오 컨테이너 스타일 */
      .video-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* 2열 그리드 */
        position: relative; 
      }
      /* 비디오 플레이어 스타일 */
      .video-player {
        width: 100%; /* 부모 컨테이너에 맞게 조절 */
        aspect-ratio: 16 / 9; /* 비디오 비율 유지 */
      }
        .custom-container {
          display: inline-block;
          background-color: #4CAF50;
        }
        .video-controls {
          position: absolute;
          bottom: 10px;
          left: 10px;
          display: none; /* 기본적으로 숨김 */
        }
    </style>
  </head>

  <body>

    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
          <a class="navbar-brand" href="#">{{ title }}</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
              <ul class="navbar-nav">
                  <li class="nav-item">
                      <form class="d-flex">
                          <input class="form-check-input" type="checkbox" id="recording_enabled" onchange="toggleRecording(this);">
                          <label class="form-check-label" for="recording_enabled">Enable Raw Recording</label>
                      </form>
                  </li>
                  <li class="nav-item">
                      <button id="startRecording" class="btn btn-primary">Start Recording</button>
                  </li>
                  <li class="nav-item">
                      <button id="stopRecording" class="btn btn-secondary">Stop Recording</button>
                  </li>
                  <li class="nav-item">
                      <button id="download" class="btn btn-success">Download</button>
                  </li>
              </ul>
          </div>
      </div>
  </nav>
      
    <div class="video-container">
      <video id="gum1" class="video-player" playsinline autoplay muted></video>
      <video id="gum2" class="video-player" playsinline autoplay muted></video>
      <video id="gum3" class="video-player" playsinline autoplay muted></video>
      <video id="gum4" class="video-player" playsinline autoplay muted></video>
      <div class="video-container">
        <!-- Video elements omitted for brevity -->
        <div class="video-controls" id="videoControls" style="display: none;">
          <!-- 통합 재생/정지 버튼 -->
          <button id="toggleVideo" class="btn btn-primary">
            <i class="fa fa-play"></i> <!-- 초기 아이콘은 재생 -->
          </button>
          <!-- 전체화면 버튼 -->
          <button onclick="toggleFullScreenContainer()" class="btn btn-light">
            <i class="fa fa-arrows-alt"></i>
          </button>
        </div>
      </div>
  </body>
</html>